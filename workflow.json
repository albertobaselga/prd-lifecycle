{
  "$schema": "https://stately.ai/schema/xstate-v5.json",
  "id": "prdLifecycle",
  "version": "2.0.0",
  "initial": "specification",
  "meta": {
    "scaffold": ["arch", "specs", "data", "sprints", "release"],
    "invariant": "compass-not-autopilot: every state is a stable checkpoint. NO always transitions, NO onDone auto-transitions. The Lead must explicitly send events to advance."
  },
  "context": {
    "instance": "",
    "team_name": "",
    "current_sprint": 0,
    "has_ai_ml": false,
    "has_analytics": false,
    "has_frontend_ui": false,
    "created_at": "",
    "product_backlog_count": 0
  },
  "states": {
    "specification": {
      "initial": "init",
      "states": {
        "init": {
          "on": {
            "SCAFFOLD_COMPLETE": {
              "target": "scaffold_complete",
              "actions": ["assignTeamName", "assignCreatedAt"]
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "STEP 0: INITIALIZATION — continue from step after init",
              "roles": "(none yet — still initializing)",
              "meaning": "Project scaffold just created",
              "previous": "(start)"
            }
          }
        },
        "scaffold_complete": {
          "on": {
            "DOMAINS_DETECTED": {
              "target": "domains_detected",
              "actions": ["assignDomainFlags"]
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "STEP 0: INITIALIZATION — continue from step after scaffold_complete",
              "roles": "(none yet — still initializing)",
              "meaning": "Team name and base state persisted",
              "previous": "init"
            }
          }
        },
        "domains_detected": {
          "on": {
            "PHASE1_SPAWNED": {
              "target": "phase1_spawned",
              "actions": []
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "STEP 0: INITIALIZATION — continue from step after domains_detected",
              "roles": "(none yet — still initializing)",
              "meaning": "Domain flags set (AI/ML, analytics, frontend)",
              "previous": "scaffold_complete"
            }
          }
        },
        "phase1_spawned": {
          "on": {
            "CEREMONY1_COMPLETE": {
              "target": "ceremony1_complete",
              "actions": []
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "PHASE 1 — resume ceremonies (check which ceremony is next)",
              "roles": "architect, data-engineer, qa-engineer, security-reviewer, tech-writer",
              "conditionalRoles": {
                "has_ai_ml": "applied-ai-engineer",
                "has_analytics": "data-scientist",
                "has_frontend_ui": "ux-ui-designer"
              },
              "meaning": "Phase 1 specialists spawned and active",
              "previous": "domains_detected"
            }
          }
        },
        "ceremony1_complete": {
          "on": {
            "CEREMONY2_COMPLETE": {
              "target": "ceremony2_complete",
              "actions": []
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "PHASE 1 — CEREMONY 2: Epic Decomposition",
              "roles": "(Phase 1 specialists should still be active)",
              "meaning": "Story Specification done — stories have acceptance criteria, initial T-shirt sizing, and profiles",
              "previous": "phase1_spawned"
            }
          }
        },
        "ceremony2_complete": {
          "on": {
            "PHASE1_COMPLETE": {
              "target": "#prdLifecycle.execution",
              "actions": ["updateBacklogCount"]
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "PHASE 1 — CEREMONY 3: Spec Validation + Backlog Finalization",
              "roles": "(Phase 1 specialists should still be active)",
              "meaning": "Epic decomposition done — epics defined, stories rationalized",
              "previous": "ceremony1_complete"
            }
          }
        }
      }
    },

    "execution": {
      "initial": "refinement",
      "states": {
        "refinement": {
          "on": {
            "REFINEMENT_DONE": {
              "target": "sprint_planning",
              "actions": ["updateBacklogCount"]
            }
          },
          "meta": {
            "nav": {
              "loadFile": "phases/phase2-sprints.md",
              "resumeAt": "REFINEMENT (R.1) — detail user stories into tasks with executor team",
              "roles": "scrum-master (facilitates), product-manager (clarifies PRD), executors (estimate + decompose)",
              "meaning": "Execution entered — Phase 1 specialists shut down. Refine backlog stories into tasks with SP.",
              "previous": "ceremony2_complete or retro_done"
            }
          }
        },
        "sprint_planning": {
          "on": {
            "PLANNING_DONE": {
              "target": "sprint",
              "actions": ["incrementSprint"]
            }
          },
          "meta": {
            "nav": {
              "loadFile": "phases/phase2-sprints.md",
              "resumeAt": "SPRINT PLANNING (P.1) — decide what enters the sprint",
              "roles": "scrum-master (presents velocity + capacity)",
              "meaning": "Backlog refined — TL + SM decide sprint scope. NOTE: current_sprint is PREVIOUS sprint number here — incrementSprint fires AFTER PLANNING_DONE.",
              "previous": "refinement"
            }
          }
        },
        "sprint": {
          "initial": "setup",
          "states": {
            "setup": {
              "on": {
                "BUILD_STARTED": {
                  "target": "build",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE A: BUILD — spawn dev teammates (A.1)",
                  "roles": "dev-1, dev-2",
                  "conditionalRoles": {
                    "has_ai_ml": "applied-ai-engineer (if AI stories in sprint)",
                    "has_frontend_ui": "ux-ui-designer (if UI stories in sprint)",
                    "has_analytics": "data-scientist (if analytics stories in sprint)"
                  },
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "Sprint directory created, stories assigned to sprint from sprint-backlog.json",
                  "previous": "sprint_planning"
                }
              }
            },
            "build": {
              "on": {
                "BUILD_DONE": {
                  "target": "build_done",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE A: BUILD — continue (teammates should be working)",
                  "roles": "dev-1, dev-2 (should be active)",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "BUILD teammates spawned and working",
                  "previous": "sprint_setup"
                }
              }
            },
            "build_done": {
              "on": {
                "VERIFY_STARTED": {
                  "target": "verify",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE B: VERIFY + REVIEW — spawn reviewers (B.1)",
                  "roles": "qa-engineer, security-reviewer, performance-reviewer, code-reviewer",
                  "extraRoles": "data-engineer (if data-heavy)",
                  "conditionalRoles": {
                    "has_ai_ml": "applied-ai-engineer",
                    "has_analytics": "data-scientist",
                    "has_frontend_ui": "ux-ui-designer"
                  },
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "BUILD complete — dev teammates shut down, code committed",
                  "previous": "sprint_build"
                }
              }
            },
            "verify": {
              "on": {
                "VERIFY_DONE": {
                  "target": "verify_done",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE B: VERIFY — continue (reviewers should be working)",
                  "roles": "qa-engineer, security-reviewer, performance-reviewer, code-reviewer (should be active)",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "VERIFY reviewers spawned and reviewing",
                  "previous": "sprint_build_done"
                }
              }
            },
            "verify_done": {
              "on": {
                "ARCH_REVIEW_STARTED": {
                  "target": "arch_review",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE C: ARCHITECTURE REVIEW — spawn architect (C.1)",
                  "roles": "architect",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "All reviews complete — reviewer teammates shut down",
                  "previous": "sprint_verify"
                }
              }
            },
            "arch_review": {
              "on": {
                "ARCH_DONE": {
                  "target": "arch_done",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SUB-PHASE C: ARCHITECTURE REVIEW — continue (C.2-C.4)",
                  "roles": "architect (should be active)",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "Architecture review in progress",
                  "previous": "sprint_verify_done"
                }
              }
            },
            "arch_done": {
              "on": {
                "REVIEW_DONE": {
                  "target": "review_done",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SPRINT REVIEW — lead writes GO/NO-GO (R.1)",
                  "roles": "(lead only — no teammates needed)",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "Architecture review passed or fixes applied",
                  "previous": "sprint_arch_review"
                }
              }
            },
            "review_done": {
              "on": {
                "RETRO_DONE": {
                  "target": "retro_done",
                  "actions": []
                }
              },
              "meta": {
                "nav": {
                  "loadFile": "phases/phase2-sprints.md",
                  "resumeAt": "SPRINT RETROSPECTIVE — collect retro input (T.1)",
                  "roles": "(message remaining active teammates)",
                  "artifactRef": "sprints/sprint-{current_sprint}/sprint-backlog.json",
                  "meaning": "GO/NO-GO decision made by lead",
                  "previous": "sprint_arch_done"
                }
              }
            },
            "retro_done": {
              "on": {
                "START_REFINEMENT": {
                  "guard": "hasRemainingStories",
                  "target": "#prdLifecycle.execution.refinement",
                  "actions": ["updateBacklogCount"]
                },
                "START_PLANNING": {
                  "guard": "hasRemainingStories",
                  "target": "#prdLifecycle.execution.sprint_planning",
                  "actions": ["updateBacklogCount"]
                },
                "START_RELEASE": {
                  "guard": "noRemainingStories",
                  "target": "#prdLifecycle.release",
                  "actions": ["updateBacklogCount"]
                }
              },
              "meta": {
                "nav": {
                  "resumeAt": "(dynamic — depends on remaining stories)",
                  "resumeAtIfStories": "Execute retro-transition checklist (T.4a-T.4f) then route based on check-refinement.sh",
                  "resumeAtIfNoStories": "PHASE 3: RELEASE — in SKILL.md (re-read if needed)",
                  "loadFileIfStories": "phases/phase2-sprints.md",
                  "roles": "(all shut down — next phase spawns fresh)",
                  "lifecycleBeforeAdvancing": "Before advancing: shut down sprint teammates (devs, reviewers, architect). SM stays alive. PM shut down after Sprint Review (if still active). Re-spawn PM at next Refinement if needed.",
                  "meaning": "Retrospective compiled, ACE learnings aggregated. Execute T.4a-T.4f checklist: update backlog, check epic status, brain event, record velocity, check refinement, route.",
                  "previous": "sprint_review_done"
                }
              }
            }
          }
        }
      }
    },

    "release": {
      "initial": "release_started",
      "states": {
        "release_started": {
          "on": {
            "RELEASE_DONE": {
              "target": "release_done",
              "actions": []
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "PHASE 3: RELEASE — continue from release_started in SKILL.md",
              "roles": "release-engineer, tech-writer",
              "meaning": "Phase 3 entered — release teammates being spawned",
              "previous": "sprint_retro_done"
            }
          }
        },
        "release_done": {
          "on": {
            "LIFECYCLE_COMPLETE": {
              "target": "#prdLifecycle.completed",
              "actions": []
            }
          },
          "meta": {
            "nav": {
              "resumeAt": "PHASE 3: RELEASE — continue from release_done in SKILL.md",
              "roles": "(none — release artifacts complete)",
              "meaning": "All release artifacts created",
              "previous": "release_started"
            }
          }
        }
      }
    },

    "completed": {
      "type": "final",
      "meta": {
        "nav": {
          "resumeAt": "DONE — present final report to user",
          "roles": "(none)",
          "meaning": "Lifecycle fully complete",
          "previous": "release_done"
        }
      }
    }
  }
}
